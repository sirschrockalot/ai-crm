# Story 3.3: Integrate Analytics with Shared Services

## Story Information
- **Story ID**: 3.3
- **Title**: Integrate Analytics with Shared Services
- **Epic**: Analytics Feature Migration
- **Sprint**: Sprint 4
- **Priority**: Medium
- **Story Points**: 5
- **Status**: Draft

## Description
Integrate analytics features with shared services and utilities to ensure consistent data processing, API handling, authentication, error handling, and performance optimization across the monolithic application.

## Acceptance Criteria
- [ ] **AC 1**: Migrate analytics API services to use shared patterns
- [ ] **AC 2**: Update data processing to use shared utilities
- [ ] **AC 3**: Integrate with shared authentication and authorization
- [ ] **AC 4**: Implement shared error handling and loading states
- [ ] **AC 5**: Update analytics data caching and optimization
- [ ] **AC 6**: Ensure all analytics integrations continue working

## Tasks

### Task 1: Migrate analytics API services (AC: 1)
- [ ] Update analytics API services to use shared `useApi` hook
- [ ] Implement consistent API client patterns for analytics endpoints
- [ ] Add proper authentication headers to analytics API calls
- [ ] Implement retry logic for analytics data requests
- [ ] Add request/response interceptors for analytics logging
- [ ] Ensure proper error handling for analytics API failures

### Task 2: Update data processing utilities (AC: 2)
- [ ] Use shared data transformation utilities for analytics data
- [ ] Implement consistent data formatting and validation
- [ ] Use shared date and currency formatting utilities
- [ ] Integrate with shared validation utilities
- [ ] Implement shared data filtering and sorting
- [ ] Use shared error handling utilities for data processing

### Task 3: Integrate authentication and authorization (AC: 3)
- [ ] Use shared `useAuth` hook for analytics authentication
- [ ] Implement role-based access control for analytics features
- [ ] Add proper authorization checks for sensitive analytics data
- [ ] Integrate with shared authentication middleware
- [ ] Implement proper token refresh for analytics sessions
- [ ] Add session management for analytics features

### Task 4: Implement shared error handling (AC: 4)
- [ ] Use shared error boundary components for analytics
- [ ] Implement consistent error message display for analytics
- [ ] Add proper error logging and reporting for analytics
- [ ] Implement error recovery mechanisms for analytics
- [ ] Add user-friendly error messages for analytics failures
- [ ] Integrate with monitoring and alerting for analytics

### Task 5: Update analytics data caching (AC: 5)
- [ ] Implement shared caching patterns for analytics data
- [ ] Use shared cache invalidation strategies
- [ ] Implement optimistic updates for analytics data
- [ ] Add proper cache warming for frequently accessed data
- [ ] Implement cache persistence across sessions
- [ ] Add cache performance monitoring

### Task 6: Verify analytics integrations (AC: 6)
- [ ] Test all analytics data fetching operations
- [ ] Verify chart and visualization data loading
- [ ] Test real-time analytics updates
- [ ] Validate analytics export functionality
- [ ] Test analytics dashboard performance
- [ ] Verify analytics data synchronization

## Dev Notes

### Previous Story Insights
This story depends on Stories 1.1, 1.2, 3.1, and 3.2 being completed. The foundation includes:
- Monolithic Next.js application structure with TypeScript
- Shared component library with UI components, layout components, and form components
- Analytics components and pages already migrated (Stories 3.1 and 3.2)
- Shared hooks including `useApi`, `useAuth`, and analytics-specific hooks
- Utility functions for data processing, error handling, and validation
- Design system with Chakra UI theme

### Data Models
Based on the architecture and previous stories:
- **Analytics Data Models**: Chart data structures and metrics [Source: Architecture_Overview_Wholesaling_CRM.md#Data Models]
- **API Response Models**: Consistent response patterns for analytics operations
- **Error Models**: Standardized error response structure for analytics
- **Cache Models**: Analytics data caching structures and strategies

### API Specifications
The analytics integration will use the following API patterns:
- **Base API Client**: Shared `useApi` hook with Axios [Source: Architecture_Overview_Wholesaling_CRM.md#Stack Overview]
- **Authentication**: Google OAuth 2.0 + JWT tokens [Source: Architecture_Overview_Wholesaling_CRM.md#Stack Overview]
- **Analytics Endpoints**: `/api/analytics`, `/api/metrics`, `/api/reports` [Source: Architecture_Overview_Wholesaling_CRM.md#Backend Structure]
- **Export Endpoints**: `/api/export` for analytics data export
- **Real-time Endpoints**: WebSocket connections for live analytics updates

### Component Specifications
No new components are required. The focus is on integrating existing analytics components with:
- **Shared Loading Components**: Use existing `Loading` component from Story 1.2
- **Shared Error Components**: Use error boundary and error display patterns
- **Shared Chart Components**: Use existing `Chart` component from Story 1.2
- **Shared UI Components**: Use Button, Modal, Table, Card components from Story 1.2

### File Locations
Based on the current project structure from Story 1.2:

```
src/frontend/
├── hooks/
│   ├── useApi.ts                    # Shared API client (already exists)
│   ├── useAuth.ts                   # Shared authentication (already exists)
│   ├── useAnalytics.ts              # Analytics data hook (update)
│   └── services/
│       ├── useAnalytics.ts          # Analytics service hook (update)
│       └── useExport.ts             # Export service hook (update)
├── components/
│   ├── ui/
│   │   ├── Loading.tsx              # Shared loading component (already exists)
│   │   ├── Chart.tsx                # Shared chart component (already exists)
│   │   └── ErrorBoundary.tsx        # Error boundary (create)
│   └── analytics/
│       ├── AnalyticsDashboard.tsx   # Analytics dashboard (update)
│       └── AnalyticsWidget.tsx      # Analytics widget (update)
├── pages/
│   ├── analytics/
│   │   ├── index.tsx                # Analytics dashboard page (update)
│   │   └── reports/
│   │       └── [id].tsx             # Report detail page (update)
│   └── dashboard.tsx                # Main dashboard (update)
└── utils/
    ├── error.ts                     # Error handling utilities (already exists)
    ├── data.ts                      # Data processing utilities (already exists)
    └── analytics.ts                 # Analytics utilities (update)
```

### Testing Requirements
Based on the architecture and previous story context:
- **Unit Tests**: Test all analytics service integrations and data processing
- **Integration Tests**: Test analytics API calls and authentication flows
- **E2E Tests**: Test complete analytics workflows and data visualization
- **Error Tests**: Test error handling and recovery scenarios for analytics
- **Performance Tests**: Test analytics data loading, caching, and visualization performance

### Technical Constraints
From the architecture documentation:
- **Authentication**: Google OAuth 2.0 + JWT [Source: Architecture_Overview_Wholesaling_CRM.md#Stack Overview]
- **API Client**: Axios with interceptors for auth and error handling
- **Data Visualization**: Recharts for charts and graphs [Source: Architecture_Overview_Wholesaling_CRM.md#Stack Overview]
- **Real-time Updates**: WebSocket integration for live analytics data
- **Caching**: Redis for analytics data caching [Source: Architecture_Overview_Wholesaling_CRM.md#Deployment Strategy]

### Integration Points
The analytics integration must work with:
- **Backend Analytics API**: NestJS analytics endpoints [Source: Architecture_Overview_Wholesaling_CRM.md#Backend Structure]
- **Real-time Data**: WebSocket connections for live analytics updates
- **Caching Layer**: Redis for analytics data caching [Source: Architecture_Overview_Wholesaling_CRM.md#Deployment Strategy]
- **Export Services**: PDF/CSV generation for analytics reports
- **Monitoring**: Prometheus + Grafana for analytics performance [Source: Architecture_Overview_Wholesaling_CRM.md#Stack Overview]

### Performance Considerations
From the architecture scalability considerations:
- **Data Caching**: Implement proper caching for analytics data
- **Optimistic Updates**: Provide immediate feedback for analytics interactions
- **Error Recovery**: Graceful handling of analytics data failures
- **State Synchronization**: Keep analytics UI state in sync with server data
- **Bundle Optimization**: Minimize analytics code bundle size

### Security Considerations
From the architecture security section:
- **Authentication**: Proper token validation and refresh for analytics
- **Authorization**: Role-based access control for analytics data
- **Data Validation**: Input validation and sanitization for analytics
- **Error Handling**: Secure error messages without exposing sensitive analytics data
- **Data Privacy**: Ensure analytics data is properly protected

### Project Structure Notes
The current project structure from Story 1.2 includes:
- `src/frontend/hooks/` - 8 custom hooks including analytics hooks
- `src/frontend/components/ui/` - 7 core UI components including Chart component
- `src/frontend/components/analytics/` - Analytics-specific components
- `src/frontend/utils/` - 5 utility modules
- `src/frontend/pages/analytics/` - Analytics pages from Story 3.2

The analytics integration must preserve this structure while ensuring all analytics features work seamlessly with shared services and provide optimal performance and user experience.

## Integration Verification
- **IV1**: Verify all analytics API integrations work correctly with proper authentication
- **IV2**: Confirm data processing and caching work as expected with shared utilities
- **IV3**: Ensure error handling and loading states work properly across all analytics features

## Next Steps
After completion of this story, Epic 3 (Analytics Feature Migration) will be complete, and the application will have fully integrated analytics features using shared services. The next epic (Epic 4: Automation Feature Migration) can proceed with migrating automation features. 