# Story 2.3: Integrate Lead Management with Shared Services

## Story Information
- **Story ID**: 2.3
- **Title**: Integrate Lead Management with Shared Services
- **Epic**: Lead Management Feature Migration
- **Sprint**: Sprint 4
- **Priority**: Medium
- **Story Points**: 5
- **Status**: Draft

## Description
Integrate lead management features with shared services and utilities to ensure consistent API handling, state management, authentication, error handling, and user feedback across the monolithic application.

## Acceptance Criteria
- [ ] **AC 1**: Migrate API services to use shared service patterns
- [ ] **AC 2**: Update state management to use shared hooks and context
- [ ] **AC 3**: Integrate with shared authentication and authorization
- [ ] **AC 4**: Update error handling to use shared error patterns
- [ ] **AC 5**: Implement shared loading states and user feedback
- [ ] **AC 6**: Ensure all API integrations continue working correctly

## Tasks

### Task 1: Migrate API services to shared patterns (AC: 1)
- [ ] Update lead management API services to use shared `useApi` hook
- [ ] Implement consistent API client patterns across all lead endpoints
- [ ] Add proper authentication headers to all API calls
- [ ] Implement retry logic for failed API requests
- [ ] Add request/response interceptors for logging
- [ ] Ensure proper error handling for API failures

### Task 2: Update state management with shared hooks (AC: 2)
- [ ] Replace local state management with shared `useLeads` hook
- [ ] Implement proper loading states using shared patterns
- [ ] Add error state management using shared error handling
- [ ] Integrate with shared context providers
- [ ] Implement optimistic updates for better UX
- [ ] Add proper state synchronization across components

### Task 3: Integrate authentication and authorization (AC: 3)
- [ ] Use shared `useAuth` hook for authentication state
- [ ] Implement role-based access control for lead operations
- [ ] Add proper authorization checks for sensitive operations
- [ ] Integrate with shared authentication middleware
- [ ] Implement proper token refresh handling
- [ ] Add session management for lead management features

### Task 4: Implement shared error handling (AC: 4)
- [ ] Use shared error boundary components
- [ ] Implement consistent error message display
- [ ] Add proper error logging and reporting
- [ ] Implement error recovery mechanisms
- [ ] Add user-friendly error messages
- [ ] Integrate with monitoring and alerting systems

### Task 5: Add shared loading states and feedback (AC: 5)
- [ ] Implement shared loading components
- [ ] Add progress indicators for long-running operations
- [ ] Implement success/error toast notifications
- [ ] Add skeleton loading states for data fetching
- [ ] Implement proper loading states for forms
- [ ] Add user feedback for all user interactions

### Task 6: Verify API integrations (AC: 6)
- [ ] Test all lead CRUD operations
- [ ] Verify pipeline management functionality
- [ ] Test communication tracking features
- [ ] Validate bulk operations
- [ ] Test import/export functionality
- [ ] Verify real-time updates and synchronization

## Dev Notes

### Previous Story Insights
This story depends on Stories 1.1, 1.2, 2.1, and 2.2 being completed. The foundation includes:
- Monolithic Next.js application structure with TypeScript
- Shared component library with UI components, layout components, and form components
- Shared hooks including `useApi`, `useAuth`, `useLeads`, `useBuyers`, `useCommunications`
- Utility functions for error handling, data transformation, and validation
- Design system with Chakra UI theme
- Lead management components and pages already migrated

### Data Models
Based on the architecture and previous stories:
- **Lead Model**: Uses the existing lead schema with proper TypeScript interfaces [Source: Architecture_Overview_Wholesaling_CRM.md#Data Models]
- **API Response Models**: Consistent response patterns for all lead operations
- **Error Models**: Standardized error response structure
- **State Models**: Proper TypeScript interfaces for all state management

### API Specifications
The integration will use the following API patterns:
- **Base API Client**: Shared `useApi` hook with Axios [Source: Architecture_Overview_Wholesaling_CRM.md#Stack Overview]
- **Authentication**: Google OAuth 2.0 + JWT tokens [Source: Architecture_Overview_Wholesaling_CRM.md#Stack Overview]
- **Lead Endpoints**: `/api/leads`, `/api/leads/:id`, `/api/leads/bulk` [Source: Architecture_Overview_Wholesaling_CRM.md#Backend Structure]
- **Communication Endpoints**: `/api/communications` for lead communication tracking
- **Pipeline Endpoints**: `/api/pipeline` for pipeline management

### Component Specifications
No new components are required. The focus is on integrating existing lead management components with:
- **Shared Loading Components**: Use existing `Loading` component from Story 1.2
- **Shared Error Components**: Use error boundary and error display patterns
- **Shared Form Components**: Use existing form validation and submission patterns
- **Shared UI Components**: Use Button, Modal, Table, Card components from Story 1.2

### File Locations
Based on the current project structure from Story 1.2:

```
src/frontend/
├── hooks/
│   ├── useApi.ts                    # Shared API client (already exists)
│   ├── useAuth.ts                   # Shared authentication (already exists)
│   ├── useLeads.ts                  # Lead management hook (already exists)
│   └── services/
│       ├── useLeads.ts              # Lead service hook (update)
│       └── useCommunications.ts     # Communication service hook (update)
├── components/
│   ├── ui/
│   │   ├── Loading.tsx              # Shared loading component (already exists)
│   │   └── ErrorBoundary.tsx        # Error boundary (create)
│   └── forms/
│       └── LeadForm.tsx             # Lead form (already exists)
├── pages/
│   ├── leads/
│   │   ├── index.tsx                # Lead management page (update)
│   │   └── [id].tsx                 # Lead detail page (update)
│   └── dashboard.tsx                # Dashboard (update)
└── utils/
    ├── error.ts                     # Error handling utilities (already exists)
    └── api.ts                       # API utilities (create)
```

### Testing Requirements
Based on the architecture and previous story context:
- **Unit Tests**: Test all service integrations and state management
- **Integration Tests**: Test API calls and authentication flows
- **E2E Tests**: Test complete lead management workflows
- **Error Tests**: Test error handling and recovery scenarios
- **Performance Tests**: Test loading states and user feedback

### Technical Constraints
From the architecture documentation:
- **Authentication**: Google OAuth 2.0 + JWT [Source: Architecture_Overview_Wholesaling_CRM.md#Stack Overview]
- **API Client**: Axios with interceptors for auth and error handling
- **State Management**: React hooks with proper TypeScript types
- **Error Handling**: Structured error responses with user-friendly messages
- **Loading States**: Consistent loading indicators across all operations

### Integration Points
The lead management integration must work with:
- **Backend API**: NestJS API running on port 3000 [Source: Architecture_Overview_Wholesaling_CRM.md#Deployment Strategy]
- **Authentication Service**: Google OAuth integration [Source: Architecture_Overview_Wholesaling_CRM.md#Stack Overview]
- **Communication Service**: Twilio integration for SMS/calls [Source: Architecture_Overview_Wholesaling_CRM.md#Stack Overview]
- **Database**: MongoDB with multi-tenant awareness [Source: Architecture_Overview_Wholesaling_CRM.md#Stack Overview]

### Performance Considerations
From the architecture scalability considerations:
- **API Caching**: Implement proper caching for lead data
- **Optimistic Updates**: Provide immediate feedback for user actions
- **Error Recovery**: Graceful handling of network failures
- **State Synchronization**: Keep UI state in sync with server state

### Security Considerations
From the architecture security section:
- **Authentication**: Proper token validation and refresh
- **Authorization**: Role-based access control for lead operations
- **Data Validation**: Input validation and sanitization
- **Error Handling**: Secure error messages without exposing sensitive data

### Project Structure Notes
The current project structure from Story 1.2 includes:
- `src/frontend/hooks/` - 8 custom hooks including service hooks
- `src/frontend/components/ui/` - 7 core UI components with tests
- `src/frontend/components/forms/` - 3 form components
- `src/frontend/utils/` - 5 utility modules
- `src/frontend/pages/` - Feature pages including leads management

The integration must preserve this structure while ensuring all lead management features work seamlessly with the shared services.

## Integration Verification
- **IV1**: Verify all API integrations work correctly with proper authentication
- **IV2**: Confirm state management functions as expected with shared hooks
- **IV3**: Ensure error handling and user feedback work properly across all features

## Next Steps
After completion of this story, Epic 2 (Lead Management Feature Migration) will be complete, and the application will have fully integrated lead management features using shared services. The next epic (Epic 3: Analytics Feature Migration) can proceed with migrating analytics features. 